import setCookie from"set-cookie-parser";import{parse}from"node-html-parser";import cookie from"cookie";import fetch from"node-fetch";import FormData from"form-data";const errors={TOO_MANY_TRIES:"Sorry, too many tries. Please try again later."};export default class MyTelegramOrg{phone;login_random_hash;sessionToken;sendCode=async e=>{this.phone=e;var o=new FormData;o.append("phone",e);e=await(await fetch("https://my.telegram.org/auth/send_password",{method:"POST",body:o})).text();if(e===errors.TOO_MANY_TRIES)return{error:"too_many_tries"};try{var r=JSON.parse(e);return this.login_random_hash=r.random_hash,{error:null,random_hash:r.random_hash}}catch(e){return console.error("Error while parsing my.telegram.org response body",e),{error:JSON.stringify(e)}}};loginWithCode=async e=>{var o=new FormData,e=(o.append("phone",this.phone),o.append("random_hash",this.login_random_hash),o.append("password",e),await fetch("https://my.telegram.org/auth/login",{method:"POST",body:o})),o=await e.text();return"Invalid confirmation code!"===o?{error:"incorrect_code"}:"true"===o?(e=e.headers.get("Set-Cookie"),e=setCookie.splitCookiesString(e),e=setCookie.parse(e,{map:!0}).stel_token?.value,(this.sessionToken=e)?{error:null,sessionToken:e}:{error:"cookie_not_found"}):{error:o}};obtainTokens=async()=>{if(!this.sessionToken)throw new Error("Session token not found. You must be logged in to obtain tokens.");var e=await fetch("https://my.telegram.org/apps",{method:"GET",headers:{Cookie:cookie.serialize("stel_token",this.sessionToken)}}),e=parse(await e.text()),o=e.querySelector("[for=app_id]+div > span > strong");if(!o)throw new Error("Unable to find app id element");e=e.querySelector("[for=app_hash]+div > span");if(e)return{appID:o.innerText,appHash:e.innerText};throw new Error("Unable to find app hash element")}}export{errors};